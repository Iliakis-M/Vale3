"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const Classes_1 = tslib_1.__importStar(require("../Classes"));
const discord_js_1 = require("discord.js");
exports.command = new Classes_1.default.Command({
    name: "avatar",
    desc: "Fetch a user's avatar",
    usage: "avatar[ username<String>]",
    exp: /^!ava(tar)?( .+)?$/smi,
    category: "Utility",
    data: {},
    body: async function body(message, vale) {
        /**
         * PROPAGATE:
         *
         * Channel > Guild > Group
         * Nickname > Username > ID
         * Emoji > Banner(?)
         */
        async function parse(message) {
            let txt = message.content.split(' ').slice(1).join(' ');
            function mentions() {
                if (message.mentions) {
                    return message.mentions.users.map((usr) => usr.avatarURL);
                }
                return [];
            } //mentions
            async function emojis() {
                let reg = /<:.+?:(\d+?)>/gui, matches = txt.match(reg);
                if (matches && matches.length) {
                    let rets = [];
                    matches = matches.map((match) => match.replace(reg, "$1"));
                    await Classes_1.chillout.forEach(matches, (match) => {
                        if (vale.client.emojis.has(match))
                            rets.push(vale.client.emojis.get(match).url);
                    });
                    return rets;
                }
                return [];
            } //emojis
            let rets = mentions().concat(await emojis());
            if (rets.length)
                return rets;
            if (message.channel instanceof discord_js_1.TextChannel) {
                let mmbs = message.channel.members.array().sort((mmb1, mmb2) => (mmb1.nickname || '').length - (mmb2.nickname || '').length), tmp = mmbs.find((mmb) => (mmb.nickname || mmb.user.username).toLowerCase().includes(txt.toLowerCase()));
                if (tmp) {
                    rets.push(tmp.user.avatarURL);
                }
                else {
                    mmbs = mmbs.sort((mmb1, mmb2) => mmb1.user.username.length - mmb2.user.username.length);
                    tmp = mmbs.find((mmb) => mmb.user.username.toLowerCase().includes(txt.toLowerCase()));
                    if (tmp) {
                        rets.push(tmp.user.avatarURL);
                    }
                    else {
                        tmp = mmbs.find((mmb) => mmb.id.toLowerCase().includes(txt.toLowerCase()));
                        if (tmp)
                            rets.push(tmp.user.avatarURL);
                    }
                }
            }
            else if (message.channel instanceof discord_js_1.GroupDMChannel) {
                let tmp = message.channel.recipients.array().sort((usr1, usr2) => (usr1.username || '').length - (usr2.username || '').length).find((usr) => usr.id.includes(txt) || usr.username.toLowerCase().includes(txt.toLowerCase()));
                if (tmp)
                    rets.push(tmp.avatarURL);
            }
            else if (message.channel instanceof discord_js_1.DMChannel) {
                let tmp = [message.channel.recipient, message.author].find((usr) => usr.username.toLowerCase().includes(txt.toLowerCase()) || usr.id.includes(txt));
                if (tmp)
                    rets.push(tmp.avatarURL);
            }
            let tmp;
            if (rets.length === 0 && (tmp = vale.client.emojis.find((emj) => emj.name.toLowerCase().includes(txt.toLowerCase()))) !== null) {
                rets.push(tmp.url);
            }
            if (rets.length === 0)
                throw "ENOTFOUND";
            return rets;
        } //parse
        let reply = Classes_1.default.failsafe.bind(message);
        try {
            if (message.content.includes(' ')) {
                reply((await parse(message)).join('\n'));
            }
            else {
                reply(message.author.avatarURL);
            }
        }
        catch (err) {
            if (message.guild) {
                reply("User not found!\n" + (message.guild.iconURL || message.guild.icon || ''));
            }
            else if (message.channel instanceof discord_js_1.GroupDMChannel) {
                reply("User not found!\n" + (message.channel.icon || ''));
            }
            else {
                reply("User not found!\n");
            }
        }
    },
});
async function init(vale) {
    exports.command.usage = vale.opts.config.prefix + exports.command.usage;
    exports.command.exp = new RegExp('^' + vale.opts.config.prefix + "ava(tar)?( .+)?$", "smi");
    return exports.command;
} //init
exports.init = init;
exports.default = init;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXZhdGFyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL2NvbW1hbmRzL2F2YXRhci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7OztBQUViLDhEQUErQztBQUMvQywyQ0FBNEk7QUFFL0gsUUFBQSxPQUFPLEdBQW9CLElBQUksaUJBQU8sQ0FBQyxPQUFPLENBQUM7SUFDM0QsSUFBSSxFQUFFLFFBQVE7SUFDZCxJQUFJLEVBQUUsdUJBQXVCO0lBQzdCLEtBQUssRUFBRSwyQkFBMkI7SUFDbEMsR0FBRyxFQUFFLHVCQUF1QjtJQUM1QixRQUFRLEVBQUUsU0FBUztJQUNuQixJQUFJLEVBQUUsRUFBRztJQUNULElBQUksRUFBRSxLQUFLLFVBQVUsSUFBSSxDQUFDLE9BQWdCLEVBQUUsSUFBa0I7UUFDN0Q7Ozs7OztXQU1HO1FBRUgsS0FBSyxVQUFVLEtBQUssQ0FBQyxPQUFnQjtZQUNwQyxJQUFJLEdBQUcsR0FBVyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRWhFLFNBQVMsUUFBUTtnQkFDaEIsSUFBSSxPQUFPLENBQUMsUUFBUSxFQUFFO29CQUNyQixPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQVMsRUFBVSxFQUFFLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2lCQUN4RTtnQkFFRCxPQUFPLEVBQUcsQ0FBQztZQUNaLENBQUMsQ0FBQyxVQUFVO1lBRVosS0FBSyxVQUFVLE1BQU07Z0JBQ3BCLElBQUksR0FBRyxHQUFXLGtCQUFrQixFQUNuQyxPQUFPLEdBQXFCLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBRTVDLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUU7b0JBQzlC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QUFDLG1CQUFtQixDQUFDLENBQUM7YUFDM0I7U0FDRDtJQUNGLENBQUM7Q0FDRCxDQUFDLENBQUM7QUFFSSxLQUFLLFVBQVUsSUFBSSxDQUFDLElBQWtCO0lBQzVDLGVBQU8sQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLGVBQU8sQ0FBQyxLQUFLLENBQUM7SUFDeEQsZUFBTyxDQUFDLEdBQUcsR0FBRyxJQUFJLE1BQU0sQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLGtCQUFrQixFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRXBGLE9BQU8sZUFBTyxDQUFDO0FBQ2hCLENBQUMsQ0FBQyxNQUFNO0FBTFIsb0JBS0M7QUFFRCxrQkFBZSxJQUFJLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcclxuXHJcbmltcG9ydCBDbGFzc2VzLCB7IGNoaWxsb3V0IH0gZnJvbSBcIi4uL0NsYXNzZXNcIjtcclxuaW1wb3J0IHsgTWVzc2FnZSwgR3VpbGRNZW1iZXIsIFVzZXIsIEd1aWxkQ2hhbm5lbCwgVGV4dENoYW5uZWwsIEdyb3VwRE1DaGFubmVsLCBETUNoYW5uZWwsIEVtb2ppLCBDb2xsZWN0aW9uLCBTbm93Zmxha2UgfSBmcm9tIFwiZGlzY29yZC5qc1wiO1xyXG5cclxuZXhwb3J0IGNvbnN0IGNvbW1hbmQ6IENsYXNzZXMuQ29tbWFuZCA9IG5ldyBDbGFzc2VzLkNvbW1hbmQoe1xyXG5cdG5hbWU6IFwiYXZhdGFyXCIsXHJcblx0ZGVzYzogXCJGZXRjaCBhIHVzZXIncyBhdmF0YXJcIixcclxuXHR1c2FnZTogXCJhdmF0YXJbIHVzZXJuYW1lPFN0cmluZz5dXCIsXHJcblx0ZXhwOiAvXiFhdmEodGFyKT8oIC4rKT8kL3NtaSxcclxuXHRjYXRlZ29yeTogXCJVdGlsaXR5XCIsXHJcblx0ZGF0YTogeyB9LFxyXG5cdGJvZHk6IGFzeW5jIGZ1bmN0aW9uIGJvZHkobWVzc2FnZTogTWVzc2FnZSwgdmFsZTogQ2xhc3Nlcy5WYWxlKTogUHJvbWlzZTx2b2lkPiB7XHJcblx0XHQvKipcclxuXHRcdCAqIFBST1BBR0FURTpcclxuXHRcdCAqIFxyXG5cdFx0ICogQ2hhbm5lbCA+IEd1aWxkID4gR3JvdXBcclxuXHRcdCAqIE5pY2tuYW1lID4gVXNlcm5hbWUgPiBJRFxyXG5cdFx0ICogRW1vamkgPiBCYW5uZXIoPylcclxuXHRcdCAqL1xyXG5cdFx0XHJcblx0XHRhc3luYyBmdW5jdGlvbiBwYXJzZShtZXNzYWdlOiBNZXNzYWdlKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xyXG5cdFx0XHRsZXQgdHh0OiBzdHJpbmcgPSBtZXNzYWdlLmNvbnRlbnQuc3BsaXQoJyAnKS5zbGljZSgxKS5qb2luKCcgJyk7XHJcblxyXG5cdFx0XHRmdW5jdGlvbiBtZW50aW9ucygpOiBzdHJpbmdbXSB7XHJcblx0XHRcdFx0aWYgKG1lc3NhZ2UubWVudGlvbnMpIHtcclxuXHRcdFx0XHRcdHJldHVybiBtZXNzYWdlLm1lbnRpb25zLnVzZXJzLm1hcCgodXNyOiBVc2VyKTogc3RyaW5nID0+IHVzci5hdmF0YXJVUkwpO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0cmV0dXJuIFsgXTtcclxuXHRcdFx0fSAvL21lbnRpb25zXHJcblxyXG5cdFx0XHRhc3luYyBmdW5jdGlvbiBlbW9qaXMoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xyXG5cdFx0XHRcdGxldCByZWc6IFJlZ0V4cCA9IC88Oi4rPzooXFxkKz8pPi9ndWksXHJcblx0XHRcdFx0XHRtYXRjaGVzOiBSZWdFeHBNYXRjaEFycmF5ID0gdHh0Lm1hdGNoKHJlZyk7XHJcblxyXG5cdFx0XHRcdGlmIChtYXRjaGVzICYmIG1hdGNoZXMubGVuZ3RoKSB7XHJcblx0XHRcdFx0XHRsZXQgcmV0cyA9IFsgXTtcclxuXHJcblx0XHRcdFx0XHRtYXRjaGVzID0gbWF0Y2hlcy5tYXAoKG1hdGNoKSA9PiBtYXRjaC5yZXBsYWNlKHJlZywgXCIkMVwiKSk7XHJcblxyXG5cdFx0XHRcdFx0YXdhaXQgY2hpbGxvdXQuZm9yRWFjaChtYXRjaGVzLCAobWF0Y2g6IHN0cmluZyk6IHZvaWQgPT4ge1xyXG5cdFx0XHRcdFx0XHRpZiAodmFsZS5jbGllbnQuZW1vamlzLmhhcyhtYXRjaCkpIHJldHMucHVzaCh2YWxlLmNsaWVudC5lbW9qaXMuZ2V0KG1hdGNoKS51cmwpO1xyXG5cdFx0XHRcdFx0fSk7XHJcblxyXG5cdFx0XHRcdFx0cmV0dXJuIHJldHM7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRyZXR1cm4gWyBdO1xyXG5cdFx0XHR9IC8vZW1vamlzXHJcblxyXG5cdFx0XHRsZXQgcmV0cyA9IG1lbnRpb25zKCkuY29uY2F0KGF3YWl0IGVtb2ppcygpKTtcclxuXHJcblx0XHRcdGlmIChyZXRzLmxlbmd0aCkgcmV0dXJuIHJldHM7XHJcblxyXG5cdFx0XHRpZiAobWVzc2FnZS5jaGFubmVsIGluc3RhbmNlb2YgVGV4dENoYW5uZWwpIHtcclxuXHRcdFx0XHRsZXQgbW1iczogR3VpbGRNZW1iZXJbXSA9IG1lc3NhZ2UuY2hhbm5lbC5tZW1iZXJzLmFycmF5KCkuc29ydCgobW1iMTogR3VpbGRNZW1iZXIsIG1tYjI6IEd1aWxkTWVtYmVyKTogbnVtYmVyID0+IChtbWIxLm5pY2tuYW1lIHx8ICcnKS5sZW5ndGggLSAobW1iMi5uaWNrbmFtZSB8fCAnJykubGVuZ3RoKSxcclxuXHRcdFx0XHRcdHRtcDogR3VpbGRNZW1iZXIgPSBtbWJzLmZpbmQoKG1tYjogR3VpbGRNZW1iZXIpOiBib29sZWFuID0+IChtbWIubmlja25hbWUgfHwgbW1iLnVzZXIudXNlcm5hbWUpLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXModHh0LnRvTG93ZXJDYXNlKCkpKTtcclxuXHRcdFx0XHRcclxuXHRcdFx0XHRpZiAodG1wKSB7XHJcblx0XHRcdFx0XHRyZXRzLnB1c2godG1wLnVzZXIuYXZhdGFyVVJMKTtcclxuXHRcdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdFx0bW1icyA9IG1tYnMuc29ydCgobW1iMTogR3VpbGRNZW1iZXIsIG1tYjI6IEd1aWxkTWVtYmVyKTogbnVtYmVyID0+IG1tYjEudXNlci51c2VybmFtZS5sZW5ndGggLSBtbWIyLnVzZXIudXNlcm5hbWUubGVuZ3RoKTtcclxuXHRcdFx0XHRcdHRtcCA9IG1tYnMuZmluZCgobW1iOiBHdWlsZE1lbWJlcik6IGJvb2xlYW4gPT4gbW1iLnVzZXIudXNlcm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyh0eHQudG9Mb3dlckNhc2UoKSkpO1xyXG5cdFx0XHRcdFx0XHJcblx0XHRcdFx0XHRpZiAodG1wKSB7XHJcblx0XHRcdFx0XHRcdHJldHMucHVzaCh0bXAudXNlci5hdmF0YXJVUkwpO1xyXG5cdFx0XHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRcdFx0dG1wID0gbW1icy5maW5kKChtbWI6IEd1aWxkTWVtYmVyKTogYm9vbGVhbiA9PiBtbWIuaWQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyh0eHQudG9Mb3dlckNhc2UoKSkpO1xyXG5cclxuXHRcdFx0XHRcdFx0aWYgKHRtcCkgcmV0cy5wdXNoKHRtcC51c2VyLmF2YXRhclVSTCk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9IGVsc2UgaWYgKG1lc3NhZ2UuY2hhbm5lbCBpbnN0YW5jZW9mIEdyb3VwRE1DaGFubmVsKSB7XHJcblx0XHRcdFx0bGV0IHRtcDogVXNlciA9IG1lc3NhZ2UuY2hhbm5lbC5yZWNpcGllbnRzLmFycmF5KCkuc29ydCgodXNyMTogVXNlciwgdXNyMjogVXNlcik6IG51bWJlciA9PiAodXNyMS51c2VybmFtZSB8fCAnJykubGVuZ3RoIC0gKHVzcjIudXNlcm5hbWUgfHwgJycpLmxlbmd0aCkuZmluZCgodXNyOiBVc2VyKTogYm9vbGVhbiA9PiB1c3IuaWQuaW5jbHVkZXModHh0KSB8fCB1c3IudXNlcm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyh0eHQudG9Mb3dlckNhc2UoKSkpO1xyXG5cclxuXHRcdFx0XHRpZiAodG1wKSByZXRzLnB1c2godG1wLmF2YXRhclVSTCk7XHJcblx0XHRcdH0gZWxzZSBpZiAobWVzc2FnZS5jaGFubmVsIGluc3RhbmNlb2YgRE1DaGFubmVsKSB7XHJcblx0XHRcdFx0bGV0IHRtcCA9IFttZXNzYWdlLmNoYW5uZWwucmVjaXBpZW50LCBtZXNzYWdlLmF1dGhvcl0uZmluZCgodXNyOiBVc2VyKTogYm9vbGVhbiA9PiB1c3IudXNlcm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyh0eHQudG9Mb3dlckNhc2UoKSkgfHwgdXNyLmlkLmluY2x1ZGVzKHR4dCkpO1xyXG5cclxuXHRcdFx0XHRpZiAodG1wKSByZXRzLnB1c2godG1wLmF2YXRhclVSTCk7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGxldCB0bXA6IEVtb2ppO1xyXG5cclxuXHRcdFx0aWYgKHJldHMubGVuZ3RoID09PSAwICYmICh0bXAgPSB2YWxlLmNsaWVudC5lbW9qaXMuZmluZCgoZW1qOiBFbW9qaSk6IGJvb2xlYW4gPT4gZW1qLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyh0eHQudG9Mb3dlckNhc2UoKSkpKSAhPT0gbnVsbCkge1xyXG5cdFx0XHRcdHJldHMucHVzaCh0bXAudXJsKTtcclxuXHRcdFx0fVxyXG5cdFx0XHRpZiAocmV0cy5sZW5ndGggPT09IDApIHRocm93IFwiRU5PVEZPVU5EXCI7XHJcblxyXG5cdFx0XHRyZXR1cm4gcmV0cztcclxuXHRcdH0gLy9wYXJzZVxyXG5cclxuXHJcblx0XHRsZXQgcmVwbHkgPSBDbGFzc2VzLmZhaWxzYWZlLmJpbmQobWVzc2FnZSk7XHJcblx0XHRcclxuXHRcdHRyeSB7XHJcblx0XHRcdFxyXG5cdFx0XHRpZiAobWVzc2FnZS5jb250ZW50LmluY2x1ZGVzKCcgJykpIHtcclxuXHRcdFx0XHRyZXBseSgoYXdhaXQgcGFyc2UobWVzc2FnZSkpLmpvaW4oJ1xcbicpKTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRyZXBseShtZXNzYWdlLmF1dGhvci5hdmF0YXJVUkwpO1xyXG5cdFx0XHR9XHJcblx0XHR9IGNhdGNoIChlcnIpIHtcclxuXHRcdFx0aWYgKG1lc3NhZ2UuZ3VpbGQpIHtcclxuXHRcdFx0XHRyZXBseShcIlVzZXIgbm90IGZvdW5kIVxcblwiICsgKG1lc3NhZ2UuZ3VpbGQuaWNvblVSTCB8fCBtZXNzYWdlLmd1aWxkLmljb24gfHwgJycpKTtcclxuXHRcdFx0fSBlbHNlIGlmIChtZXNzYWdlLmNoYW5uZWwgaW5zdGFuY2VvZiBHcm91cERNQ2hhbm5lbCkge1xyXG5cdFx0XHRcdHJlcGx5KFwiVXNlciBub3QgZm91bmQhXFxuXCIgKyAobWVzc2FnZS5jaGFubmVsLmljb24gfHwgJycpKTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRyZXBseShcIlVzZXIgbm90IGZvdW5kIVxcblwiKTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdH0sIC8vYm9keVxyXG59KTtcclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBpbml0KHZhbGU6IENsYXNzZXMuVmFsZSk6IFByb21pc2U8Q2xhc3Nlcy5Db21tYW5kPiB7XHJcblx0Y29tbWFuZC51c2FnZSA9IHZhbGUub3B0cy5jb25maWcucHJlZml4ICsgY29tbWFuZC51c2FnZTtcclxuXHRjb21tYW5kLmV4cCA9IG5ldyBSZWdFeHAoJ14nICsgdmFsZS5vcHRzLmNvbmZpZy5wcmVmaXggKyBcImF2YSh0YXIpPyggLispPyRcIiwgXCJzbWlcIik7XHJcblxyXG5cdHJldHVybiBjb21tYW5kO1xyXG59IC8vaW5pdFxyXG5cclxuZXhwb3J0IGRlZmF1bHQgaW5pdDtcclxuIl19