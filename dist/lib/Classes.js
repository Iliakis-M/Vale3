"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const vale3_1 = tslib_1.__importDefault(require("./vale3"));
const Discord = tslib_1.__importStar(require("discord.js"));
const fs = tslib_1.__importStar(require("fs-extra"));
const path = tslib_1.__importStar(require("path"));
const events_1 = require("events");
const os_1 = require("os");
const util_1 = require("util");
const https_1 = require("https");
const chillout = tslib_1.__importStar(require("chillout"));
exports.chillout = chillout;
exports.chalk = require("chalk");
try {
    exports.stripAnsi = require("strip-ansi");
}
catch (opt) {
    exports.stripAnsi = (c) => c;
}
/**
 * VAL-1: TO BE USED BOTH WITH USER AND BOTS ACCOUNTS  - can make botnet
 * VAL-2: RELOAD ONLY MODIFIED MODULES/COMMANDS!  - external handling, _loadCMD supports singlefile
 * VAL-3: CLEAR UNDERLYING LOGSTRINGS PERIODICALLY
 * VAL-4: CACHEBANK AND NAMEDCACHEBANK IMPLEMENTATION
 */
var Classes;
(function (Classes) {
    let Errors;
    (function (Errors) {
        Errors.EBADSZ = new RangeError("Bad Size.");
    })(Errors = Classes.Errors || (Classes.Errors = {})); //Errors
    class Vale extends events_1.EventEmitter {
        constructor(opts = Vale.defaultOpts) {
            super();
            this.commands = new Map();
            let nopts = {};
            Object.assign(nopts, Vale.defaultOpts);
            Object.assign(nopts, opts);
            this.opts = nopts;
            this.client = new Discord.Client(opts.config.client);
        } //ctor
        //@Override
        on(event, listener) {
            return super.on(event, listener);
        } //on
        //@Override
        once(event, listener) {
            return super.once(event, listener);
        } //once
        start() {
            vale3_1.default.setup(this);
            this.client.login(this.opts.token); //!destroy()
            return this;
        } //start
        async command(message) {
            try {
                let found = Array.from(this.commands.values()).find((cmd) => cmd.exp.test(message.content));
                if (found) {
                    //@ts-ignore
                    this._debug(exports.chalk.keyword("orange").dim(message.author.tag + " (" + message.channel.name + "  -  [ " + (message.guild || { name: "undefined" }).name + " ] )") + ":", exports.chalk.yellow(message.content), "---", exports.chalk.grey.dim(Date()));
                    return await found.body(message, this);
                }
            }
            catch (err) {
                return this._debug(exports.chalk.red(util_1.inspect(err)));
            }
        } //command
        _debug(...msg) {
            let prec;
            this._debuglog += (prec = msg.join(' ')) + " --- " + Date() + os_1.EOL;
            this.emit("log", prec);
            this.emit("rawlog", exports.stripAnsi(prec));
            if (this._panel && this._panel.sock)
                this._panel.sock.of("/admin").to("admin").send(exports.stripAnsi(prec));
            return prec;
        } //_debug
        async _loadCMD(from = "dist/lib/commands/") {
            let stats = await fs.stat(from);
            if (stats.isDirectory()) {
                let files = await fs.readdir(from);
                await chillout.forOf(files, async (file) => {
                    let comm, full;
                    try {
                        delete require.cache[require.resolve(full = path.resolve(path.join(from, file)))];
                        comm = require(full);
                        await comm.init(this);
                    }
                    catch (err) {
                        this._debug(exports.chalk.red(util_1.inspect(err)));
                        return;
                    }
                    this.commands.set(comm.command.name, comm.command);
                });
                this._debug(exports.chalk.cyan.dim("Loaded bot commands"), exports.chalk.grey.dim(" ---  " + Date()));
            }
            else {
                let comm, full;
                try {
                    delete require.cache[require.resolve(full = path.resolve(from))];
                    comm = require(full);
                    await comm.init(this);
                }
                catch (err) {
                    this._debug(exports.chalk.red(util_1.inspect(err)));
                    return this;
                }
                this.commands.set(comm.command.name, comm.command);
                this._debug(exports.chalk.cyan.dim("Loaded bot command: " + from), exports.chalk.grey.dim(" ---  " + Date()));
            }
            return this;
        } //_loadCMD
    } //Vale
    Vale.defaultOpts = {
        token: '',
        config: {
            prefix: '!',
            cust: "cust.config.json",
            client: {
                messageCacheLifetime: 1800,
                disableEveryone: true
            }
        },
        custconfig: {}
    };
    Classes.Vale = Vale;
    class Command {
        constructor(opts) {
            this.desc = '';
            this.usage = '';
            this.category = '';
            this.data = {};
            Object.assign(this, opts);
        } //ctor
        //@Override
        async body(message, vale) {
            //can support non-message commanding?
        } //body
        //@Override
        async _remove(vale) {
            //cleanup(?)
        } //_remove
    } //Command
    Classes.Command = Command;
    class CacheBank {
        constructor(name, size = 50, autopurge = true, reusables = true) {
            this.size = 50;
            this.cache = [];
            this.name = "CacheBank-" + CacheBank.cntr++;
            this.autopurge = false;
            this.reusables = false;
            this.name = name || this.name;
            this.size = size || this.size;
            this.autopurge = autopurge || this.autopurge;
            this.reusables = reusables || this.reusables;
        } //ctor
        get(item) {
            if (this.cache.length === 0)
                throw Errors.EBADSZ;
            if (item === undefined || item === null) {
                let idx = Math.round(Math.random() * (this.cache.length - 1)), tmp = this.cache[idx];
                if (this.reusables === false)
                    this.cache.splice(idx, 1);
                return tmp.entry;
            }
            else {
                let tmp = this.cache[item];
                if (this.reusables === false)
                    this.cache.splice(item, 1);
                return tmp.entry;
            }
        } //random
        async purge(items = 1) {
            let out = [];
            this._arrange();
            await chillout.until(() => {
                out.push(this.cache.shift());
                if (!items--)
                    return chillout.StopIteration;
            });
            return out;
        } //purge
        push(item) {
            if (this.autopurge && this.cache.length === this.size - 1)
                this.purge();
            return this.cache.push({
                entry: item,
                timestamp: Date.now()
            });
        } //push
        _arrange() {
            return this.cache = this.cache.sort((a, b) => a.timestamp - b.timestamp);
        } //_arrange
    } //CacheBank
    CacheBank.cntr = 0;
    Classes.CacheBank = CacheBank;
    async function fetch(url) {
        return new Promise((res, rej) => {
            https_1.get(url, (resp) => {
                let reply = '';
                resp.on("data", (chunk) => {
                    reply += chunk;
                });
                resp.once("close", () => res(decodeURIComponent(reply)));
            }).once("error", rej);
        });
    } //fetch
    Classes.fetch = fetch;
    async function failsafe(...params) {
        try {
            return await this.reply(...params);
        }
        catch (err) {
            return await this.author.send(...params);
        }
    } //failsafe
    Classes.failsafe = failsafe;
})(Classes = exports.Classes || (exports.Classes = {})); //Classes
exports.default = Classes;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2xhc3Nlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9DbGFzc2VzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7O0FBRWIsNERBQTRCO0FBQzVCLDREQUFzQztBQUV0QyxxREFBK0I7QUFDL0IsbURBQTZCO0FBQzdCLG1DQUFzQztBQUN0QywyQkFBeUI7QUFDekIsK0JBQStCO0FBQy9CLGlDQUE0QztBQUc1QywyREFBcUM7QUFrVTVCLDRCQUFRO0FBaFVKLFFBQUEsS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUt0QyxJQUFJO0lBQ0gsaUJBQVMsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7Q0FDbEM7QUFBQyxPQUFPLEdBQUcsRUFBRTtJQUNiLGlCQUFTLEdBQUcsQ0FBQyxDQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztDQUMxQjtBQUdEOzs7OztHQUtHO0FBR0gsSUFBYyxPQUFPLENBeVNwQjtBQXpTRCxXQUFjLE9BQU87SUFrRHBCLElBQWlCLE1BQU0sQ0FJdEI7SUFKRCxXQUFpQixNQUFNO1FBRVQsYUFBTSxHQUFlLElBQUksVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBRS9ELENBQUMsRUFKZ0IsTUFBTSxHQUFOLGNBQU0sS0FBTixjQUFNLFFBSXRCLENBQUMsUUFBUTtJQVNWLE1BQWEsSUFBSyxTQUFRLHFCQUFZO1FBc0JyQyxZQUFtQixPQUF5QixJQUFJLENBQUMsV0FBVztZQUMzRCxLQUFLLEVBQUUsQ0FBQztZQWhCVCxhQUFRLEdBQXlCLElBQUksR0FBRyxFQUFFLENBQUM7WUFrQjFDLElBQUksS0FBSyxHQUF1QyxFQUFHLENBQUM7WUFDcEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzNCLElB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QUksS0FBSyxDQUFDO2dCQUNoQixDQUFDLENBQUMsQ0FBQztnQkFDSCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFELENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDdkIsQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDLENBQUMsT0FBTztJQVhhLGFBQUssUUFXMUIsQ0FBQTtJQUVNLEtBQUssVUFBVSxRQUFRLENBQXdCLEdBQUcsTUFBYTtRQUNyRSxJQUFJO1lBQ0gsT0FBTyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQztTQUNuQztRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ2IsT0FBTyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUM7U0FDekM7SUFDRixDQUFDLENBQUMsVUFBVTtJQU5VLGdCQUFRLFdBTTdCLENBQUE7QUFFRixDQUFDLEVBelNhLE9BQU8sR0FBUCxlQUFPLEtBQVAsZUFBTyxRQXlTcEIsQ0FBQyxTQUFTO0FBRVgsa0JBQWUsT0FBTyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG5pbXBvcnQgVmFsZTMgZnJvbSBcIi4vdmFsZTNcIjtcclxuaW1wb3J0ICogYXMgRGlzY29yZCBmcm9tIFwiZGlzY29yZC5qc1wiO1xyXG5pbXBvcnQgKiBhcyBhZG1fcGFuZWwgZnJvbSBcImFkbS1wYW5lbDJcIjtcclxuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCI7XHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcclxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSBcImV2ZW50c1wiO1xyXG5pbXBvcnQgeyBFT0wgfSBmcm9tIFwib3NcIjtcclxuaW1wb3J0IHsgaW5zcGVjdCB9IGZyb20gXCJ1dGlsXCI7XHJcbmltcG9ydCB7IGdldCwgUmVxdWVzdE9wdGlvbnMgfSBmcm9tIFwiaHR0cHNcIjtcclxuaW1wb3J0IHsgVVJMIH0gZnJvbSBcInVybFwiO1xyXG5pbXBvcnQgeyBJbmNvbWluZ01lc3NhZ2UgfSBmcm9tIFwiaHR0cFwiO1xyXG5pbXBvcnQgKiBhcyBjaGlsbG91dCBmcm9tIFwiY2hpbGxvdXRcIjtcclxuXHJcbmV4cG9ydCBjb25zdCBjaGFsayA9IHJlcXVpcmUoXCJjaGFsa1wiKTtcclxuZXhwb3J0IHZhciBzdHJpcEFuc2k6IHtcclxuXHQoYzogYW55KTogYW55O1xyXG59O1xyXG5cclxudHJ5IHtcclxuXHRzdHJpcEFuc2kgPSByZXF1aXJlKFwic3RyaXAtYW5zaVwiKTtcclxufSBjYXRjaCAob3B0KSB7XHJcblx0c3RyaXBBbnNpID0gKGM6IGFueSkgPT4gYztcclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiBWQUwtMTogVE8gQkUgVVNFRCBCT1RIIFdJVEggVVNFUiBBTkQgQk9UUyBBQ0NPVU5UUyAgLSBjYW4gbWFrZSBib3RuZXRcclxuICogVkFMLTI6IFJFTE9BRCBPTkxZIE1PRElGSUVEIE1PRFVMRVMvQ09NTUFORFMhICAtIGV4dGVybmFsIGhhbmRsaW5nLCBfbG9hZENNRCBzdXBwb3J0cyBzaW5nbGVmaWxlXHJcbiAqIFZBTC0zOiBDTEVBUiBVTkRFUkxZSU5HIExPR1NUUklOR1MgUEVSSU9ESUNBTExZXHJcbiAqIFZBTC00OiBDQUNIRUJBTksgQU5EIE5BTUVEQ0FDSEVCQU5LIElNUExFTUVOVEFUSU9OXHJcbiAqL1xyXG5cclxuXHJcbmV4cG9ydCBtb2R1bGUgQ2xhc3NlcyB7XHJcblxyXG5cdGV4cG9ydCBuYW1lc3BhY2UgT3B0aW9ucyB7XHJcblxyXG5cdFx0ZXhwb3J0IGludGVyZmFjZSBWYWxlT3B0cyB7XHJcblxyXG5cdFx0XHRyZWFkb25seSB0b2tlbjogc3RyaW5nO1xyXG5cdFx0XHRjb25maWc6IHtcclxuXHRcdFx0XHRjdXN0Pzogc3RyaW5nIHwgbnVtYmVyIHwgQnVmZmVyO1xyXG5cdFx0XHRcdHByZWZpeDogc3RyaW5nO1xyXG5cdFx0XHRcdGNsaWVudD86IERpc2NvcmQuQ2xpZW50T3B0aW9ucztcclxuXHRcdFx0fTtcclxuXHRcdFx0Y3VzdGNvbmZpZz86IHtcclxuXHRcdFx0XHRwYW5lbD86IGFueTtcclxuXHRcdFx0XHR3aG9vaz86IGFueTtcclxuXHRcdFx0XHRbaWR4OiBzdHJpbmddOiBhbnk7XHJcblx0XHRcdH07XHJcblxyXG5cdFx0fSAvL1ZhbGVPcHRzXHJcblxyXG5cdFx0ZXhwb3J0IGludGVyZmFjZSBDb21tYW5kT3B0cyB7XHJcblxyXG5cdFx0XHRuYW1lOiBzdHJpbmc7XHJcblx0XHRcdGV4cDogUmVnRXhwO1xyXG5cdFx0XHRkZXNjPzogc3RyaW5nO1xyXG5cdFx0XHR1c2FnZT86IHN0cmluZztcclxuXHRcdFx0LyoqIFV0aWxpdHksIE93bmVyLCBBZG1pblxyXG5cdFx0XHQgKiBAdHlwZSB7c3RyaW5nfVxyXG5cdFx0XHQgKiBAbWVtYmVyb2YgQ29tbWFuZE9wdHNcclxuXHRcdFx0ICovXHJcblx0XHRcdGNhdGVnb3J5Pzogc3RyaW5nO1xyXG5cdFx0XHRkYXRhPzogYW55O1xyXG5cdFx0XHRib2R5OiAobWVzc2FnZTogRGlzY29yZC5NZXNzYWdlLCB2YWxlOiBWYWxlKSA9PiBQcm9taXNlPGFueT47XHJcblx0XHRcdF9yZW1vdmU/OiAodmFsZT86IFZhbGUpID0+IFByb21pc2U8YW55PjtcclxuXHJcblx0XHR9IC8vQ29tbWFuZE9wdHNcclxuXHJcblx0XHRleHBvcnQgaW50ZXJmYWNlIENhY2hlQmFua09wdHMge1xyXG5cclxuXHRcdFx0c2l6ZTogbnVtYmVyO1xyXG5cdFx0XHRjYWNoZTogQ2FjaGVFbnRyeVtdO1xyXG5cdFx0XHRuYW1lPzogc3RyaW5nO1xyXG5cdFx0XHRhdXRvcHVyZ2U/OiBib29sZWFuO1xyXG5cdFx0XHRyZXVzYWJsZXM/OiBib29sZWFuO1xyXG5cclxuXHRcdH0gLy9DYWNoZUJhbmtPcHRzXHJcblxyXG5cdH0gLy9PcHRpb25zXHJcblxyXG5cclxuXHRleHBvcnQgbmFtZXNwYWNlIEVycm9ycyB7XHJcblxyXG5cdFx0ZXhwb3J0IGNvbnN0IEVCQURTWjogUmFuZ2VFcnJvciA9IG5ldyBSYW5nZUVycm9yKFwiQmFkIFNpemUuXCIpO1xyXG5cclxuXHR9IC8vRXJyb3JzXHJcblxyXG5cclxuXHRleHBvcnQgdHlwZSBDYWNoZUVudHJ5ID0ge1xyXG5cdFx0dGltZXN0YW1wOiBudW1iZXI7XHJcblx0XHRlbnRyeTogYW55XHJcblx0fTtcclxuXHJcblxyXG5cdGV4cG9ydCBjbGFzcyBWYWxlIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcclxuXHJcblx0XHRyZWFkb25seSBvcHRzOiBPcHRpb25zLlZhbGVPcHRzO1xyXG5cdFx0cmVhZG9ubHkgY2xpZW50OiBEaXNjb3JkLkNsaWVudDtcclxuXHRcdHdob29rOiBEaXNjb3JkLldlYmhvb2s7XHJcblx0XHRfZGVidWdsb2c6IHN0cmluZztcclxuXHRcdF9wYW5lbDogYWRtX3BhbmVsLkNsYXNzZXMuUGFuZWw7XHJcblx0XHRjb21tYW5kczogTWFwPHN0cmluZywgQ29tbWFuZD4gPSBuZXcgTWFwKCk7XHJcblxyXG5cdFx0cHVibGljIHN0YXRpYyBkZWZhdWx0T3B0czogT3B0aW9ucy5WYWxlT3B0cyA9IHtcclxuXHRcdFx0dG9rZW46ICcnLFxyXG5cdFx0XHRjb25maWc6IHtcclxuXHRcdFx0XHRwcmVmaXg6ICchJyxcclxuXHRcdFx0XHRjdXN0OiBcImN1c3QuY29uZmlnLmpzb25cIixcclxuXHRcdFx0XHRjbGllbnQ6IHtcclxuXHRcdFx0XHRcdG1lc3NhZ2VDYWNoZUxpZmV0aW1lOiAxODAwLFxyXG5cdFx0XHRcdFx0ZGlzYWJsZUV2ZXJ5b25lOiB0cnVlXHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9LFxyXG5cdFx0XHRjdXN0Y29uZmlnOiB7IH1cclxuXHRcdH07XHJcblxyXG5cdFx0cHVibGljIGNvbnN0cnVjdG9yKG9wdHM6IE9wdGlvbnMuVmFsZU9wdHMgPSBWYWxlLmRlZmF1bHRPcHRzKSB7XHJcblx0XHRcdHN1cGVyKCk7XHJcblxyXG5cdFx0XHRsZXQgbm9wdHM6IE9wdGlvbnMuVmFsZU9wdHMgPSA8T3B0aW9ucy5WYWxlT3B0cz57IH07XHJcblx0XHRcdE9iamVjdC5hc3NpZ24obm9wdHMsIFZhbGUuZGVmYXVsdE9wdHMpO1xyXG5cdFx0XHRPYmplY3QuYXNzaWduKG5vcHRzLCBvcHRzKTtcclxuXHRcdFx0dGhpcy5vcHRzID0gbm9wdHM7XHJcblxyXG5cdFx0XHR0aGlzLmNsaWVudCA9IG5ldyBEaXNjb3JkLkNsaWVudChvcHRzLmNvbmZpZy5jbGllbnQpO1xyXG5cdFx0fSAvL2N0b3JcclxuXHJcblx0XHQvL0BPdmVycmlkZVxyXG5cdFx0cHVibGljIG9uKGV2ZW50OiBcImxvZ1wiLCBsaXN0ZW5lcjogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKTogdGhpcztcclxuXHRcdHB1YmxpYyBvbihldmVudDogXCJyYXdsb2dcIiwgbGlzdGVuZXI6ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCk6IHRoaXM7XHJcblx0XHQvL0BPdmVycmlkZVxyXG5cdFx0cHVibGljIG9uKGV2ZW50OiBzdHJpbmcgfCBzeW1ib2wsIGxpc3RlbmVyOiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpOiB0aGlzIHtcclxuXHRcdFx0cmV0dXJuIHN1cGVyLm9uKGV2ZW50LCBsaXN0ZW5lcik7XHJcblx0XHR9IC8vb25cclxuXHJcblx0XHQvL0BPdmVycmlkZVxyXG5cdFx0cHVibGljIG9uY2UoZXZlbnQ6IFwibG9nXCIsIGxpc3RlbmVyOiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpOiB0aGlzO1xyXG5cdFx0cHVibGljIG9uY2UoZXZlbnQ6IFwicmF3bG9nXCIsIGxpc3RlbmVyOiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpOiB0aGlzO1xyXG5cdFx0Ly9AT3ZlcnJpZGVcclxuXHRcdHB1YmxpYyBvbmNlKGV2ZW50OiBzdHJpbmcgfCBzeW1ib2wsIGxpc3RlbmVyOiAoLi4uYXJnczogYW55W10pID0+IHZvaWQpOiB0aGlzIHtcclxuXHRcdFx0cmV0dXJuIHN1cGVyLm9uY2UoZXZlbnQsIGxpc3RlbmVyKTtcclxuXHRcdH0gLy9vbmNlXHJcblxyXG5cdFx0cHVibGljIHN0YXJ0KCkge1xyXG5cdFx0XHRWYWxlMy5zZXR1cCh0aGlzKTtcclxuXHRcdFx0dGhpcy5jbGllbnQubG9naW4odGhpcy5vcHRzLnRva2VuKTsgIC8vIWRlc3Ryb3koKVxyXG5cdFx0XHRyZXR1cm4gdGhpcztcclxuXHRcdH0gLy9zdGFydFxyXG5cclxuXHRcdHB1YmxpYyBhc3luYyBjb21tYW5kKG1lc3NhZ2U6IERpc2NvcmQuTWVzc2FnZSk6IFByb21pc2U8YW55PiB7XHJcblx0XHRcdHRyeSB7XHJcblx0XHRcdFx0bGV0IGZvdW5kOiBDb21tYW5kID0gQXJyYXkuZnJvbSh0aGlzLmNvbW1hbmRzLnZhbHVlcygpKS5maW5kKChjbWQ6IENvbW1hbmQpID0+IGNtZC5leHAudGVzdChtZXNzYWdlLmNvbnRlbnQpKTtcclxuXHJcblx0XHRcdFx0aWYgKGZvdW5kKSB7XHJcblx0XHRcdFx0XHQvL0B0cy1pZ25vcmVcclxuXHRcdFx0XHRcdHRoaXMuX2RlYnVnKGNoYWxrLmtleXdvcmQoXCJvcmFuZ2VcIikuZGltKG1lc3NhZ2UuYXV0aG9yLnRhZyArIFwiIChcIiArIG1lc3NhZ2UuY2hhbm5lbC5uYW1lICsgXCIgIC0gIFsgXCIgKyAobWVzc2FnZS5ndWlsZCB8fCB7IG5hbWU6IFwidW5kZWZpbmVkXCIgfSkubmFtZSArIFwiIF0gKVwiKSArIFwiOlwiLCBjaGFsay55ZWxsb3cobWVzc2FnZS5jb250ZW50KSwgXCItLS1cIiwgY2hhbGsuZ3JleS5kaW0oRGF0ZSgpKSk7XHJcblx0XHRcdFx0XHRyZXR1cm4gYXdhaXQgZm91bmQuYm9keShtZXNzYWdlLCB0aGlzKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0gY2F0Y2ggKGVycikge1xyXG5cdFx0XHRcdHJldHVybiB0aGlzLl9kZWJ1ZyhjaGFsay5yZWQoaW5zcGVjdChlcnIpKSk7XHJcblx0XHRcdH1cclxuXHRcdH0gLy9jb21tYW5kXHJcblxyXG5cdFx0X2RlYnVnKC4uLm1zZzogYW55KTogc3RyaW5nIHtcclxuXHRcdFx0bGV0IHByZWM6IHN0cmluZztcclxuXHRcdFx0dGhpcy5fZGVidWdsb2cgKz0gKHByZWMgPSBtc2cuam9pbignICcpKSArIFwiIC0tLSBcIiArIERhdGUoKSArIEVPTDtcclxuXHRcdFx0dGhpcy5lbWl0KFwibG9nXCIsIHByZWMpO1xyXG5cdFx0XHR0aGlzLmVtaXQoXCJyYXdsb2dcIiwgc3RyaXBBbnNpKHByZWMpKTtcclxuXHRcdFx0aWYgKHRoaXMuX3BhbmVsICYmIHRoaXMuX3BhbmVsLnNvY2spIHRoaXMuX3BhbmVsLnNvY2sub2YoXCIvYWRtaW5cIikudG8oXCJhZG1pblwiKS5zZW5kKHN0cmlwQW5zaShwcmVjKSk7XHJcblx0XHRcdHJldHVybiBwcmVjO1xyXG5cdFx0fSAvL19kZWJ1Z1xyXG5cclxuXHRcdGFzeW5jIF9sb2FkQ01EKGZyb206IHN0cmluZyA9IFwiZGlzdC9saWIvY29tbWFuZHMvXCIpOiBQcm9taXNlPHRoaXM+IHtcclxuXHRcdFx0bGV0IHN0YXRzOiBmcy5TdGF0cyA9IGF3YWl0IGZzLnN0YXQoZnJvbSk7XHJcblxyXG5cdFx0XHRpZiAoc3RhdHMuaXNEaXJlY3RvcnkoKSkge1xyXG5cdFx0XHRcdGxldCBmaWxlczogc3RyaW5nW10gPSBhd2FpdCBmcy5yZWFkZGlyKGZyb20pO1xyXG5cclxuXHRcdFx0XHRhd2FpdCBjaGlsbG91dC5mb3JPZihmaWxlcywgYXN5bmMgKGZpbGU6IHN0cmluZyk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG5cdFx0XHRcdFx0bGV0IGNvbW06IGFueSxcclxuXHRcdFx0XHRcdFx0ZnVsbDogc3RyaW5nO1xyXG5cdFx0XHRcdFxyXG5cdFx0XHRcdFx0dHJ5IHtcclxuXHRcdFx0XHRcdFx0ZGVsZXRlIHJlcXVpcmUuY2FjaGVbcmVxdWlyZS5yZXNvbHZlKGZ1bGwgPSBwYXRoLnJlc29sdmUocGF0aC5qb2luKGZyb20sIGZpbGUpKSldO1xyXG5cdFx0XHRcdFx0XHRjb21tID0gcmVxdWlyZShmdWxsKTtcclxuXHRcdFx0XHRcdFx0YXdhaXQgY29tbS5pbml0KHRoaXMpO1xyXG5cdFx0XHRcdFx0fSBjYXRjaCAoZXJyKSB7XHJcblx0XHRcdFx0XHRcdHRoaXMuX2RlYnVnKGNoYWxrLnJlZChpbnNwZWN0KGVycikpKTtcclxuXHRcdFx0XHRcdFx0cmV0dXJuO1xyXG5cdFx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRcdHRoaXMuY29tbWFuZHMuc2V0KGNvbW0uY29tbWFuZC5uYW1lLCBjb21tLmNvbW1hbmQpO1xyXG5cdFx0XHRcdH0pO1xyXG5cclxuXHRcdFx0XHR0aGlzLl9kZWJ1ZyhjaGFsay5jeWFuLmRpbShcIkxvYWRlZCBib3QgY29tbWFuZHNcIiksIGNoYWxrLmdyZXkuZGltKFwiIC0tLSAgXCIgKyBEYXRlKCkpKTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRsZXQgY29tbTogYW55LFxyXG5cdFx0XHRcdFx0ZnVsbDogc3RyaW5nO1xyXG5cclxuXHRcdFx0XHR0cnkge1xyXG5cdFx0XHRcdFx0ZGVsZXRlIHJlcXVpcmUuY2FjaGVbcmVxdWlyZS5yZXNvbHZlKGZ1bGwgPSBwYXRoLnJlc29sdmUoZnJvbSkpXTtcclxuXHRcdFx0XHRcdGNvbW0gPSByZXF1aXJlKGZ1bGwpO1xyXG5cdFx0XHRcdFx0YXdhaXQgY29tbS5pbml0KHRoaXMpO1xyXG5cdFx0XHRcdH0gY2F0Y2ggKGVycikge1xyXG5cdFx0XHRcdFx0dGhpcy5fZGVidWcoY2hhbGsucmVkKGluc3BlY3QoZXJyKSkpO1xyXG5cdFx0XHRcdFx0cmV0dXJuIHRoaXM7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHR0aGlzLmNvbW1hbmRzLnNldChjb21tLmNvbW1hbmQubmFtZSwgY29tbS5jb21tYW5kKTtcclxuXHRcdFx0XHR0aGlzLl9kZWJ1ZyhjaGFsay5jeWFuLmRpbShcIkxvYWRlZCBib3QgY29tbWFuZDogXCIgKyBmcm9tKSwgY2hhbGsuZ3JleS5kaW0oXCIgLS0tICBcIiArIERhdGUoKSkpO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHRyZXR1cm4gdGhpcztcclxuXHRcdH0gLy9fbG9hZENNRFxyXG5cclxuXHR9IC8vVmFsZVxyXG5cclxuXHRleHBvcnQgY2xhc3MgQ29tbWFuZCBpbXBsZW1lbnRzIE9wdGlvbnMuQ29tbWFuZE9wdHMge1xyXG5cclxuXHRcdHB1YmxpYyByZWFkb25seSBuYW1lOiBzdHJpbmc7XHJcblx0XHRwdWJsaWMgZXhwOiBSZWdFeHA7XHJcblx0XHRwdWJsaWMgZGVzYz86IHN0cmluZyA9ICcnO1xyXG5cdFx0cHVibGljIHVzYWdlPzogc3RyaW5nID0gJyc7XHJcblx0XHRwdWJsaWMgY2F0ZWdvcnk/OiBzdHJpbmcgPSAnJztcclxuXHRcdHB1YmxpYyBkYXRhPzogYW55ID0geyB9O1xyXG5cdFx0XHJcblx0XHRwdWJsaWMgY29uc3RydWN0b3Iob3B0czogT3B0aW9ucy5Db21tYW5kT3B0cykge1xyXG5cdFx0XHRPYmplY3QuYXNzaWduKHRoaXMsIG9wdHMpO1xyXG5cdFx0fSAvL2N0b3JcclxuXHJcblx0XHQvL0BPdmVycmlkZVxyXG5cdFx0cHVibGljIGFzeW5jIGJvZHkobWVzc2FnZT86IERpc2NvcmQuTWVzc2FnZSwgdmFsZT86IFZhbGUpOiBQcm9taXNlPGFueT4ge1xyXG5cdFx0XHQvL2NhbiBzdXBwb3J0IG5vbi1tZXNzYWdlIGNvbW1hbmRpbmc/XHJcblx0XHR9IC8vYm9keVxyXG5cclxuXHRcdC8vQE92ZXJyaWRlXHJcblx0XHRhc3luYyBfcmVtb3ZlKHZhbGU/OiBWYWxlKTogUHJvbWlzZTxhbnk+IHtcclxuXHRcdFx0Ly9jbGVhbnVwKD8pXHJcblx0XHR9IC8vX3JlbW92ZVxyXG5cclxuXHR9IC8vQ29tbWFuZFxyXG5cclxuXHRleHBvcnQgY2xhc3MgQ2FjaGVCYW5rIGltcGxlbWVudHMgT3B0aW9ucy5DYWNoZUJhbmtPcHRzIHtcclxuXHJcblx0XHRwdWJsaWMgc2l6ZTogbnVtYmVyID0gNTA7XHJcblx0XHRjYWNoZTogQ2FjaGVFbnRyeVtdID0gWyBdO1xyXG5cdFx0cHVibGljIG5hbWU6IHN0cmluZyA9IFwiQ2FjaGVCYW5rLVwiICsgQ2FjaGVCYW5rLmNudHIrKztcclxuXHRcdHB1YmxpYyBhdXRvcHVyZ2U6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHRcdHB1YmxpYyByZXVzYWJsZXM6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcblx0XHRwcml2YXRlIHN0YXRpYyBjbnRyOiBudW1iZXIgPSAwO1xyXG5cclxuXHRcdHB1YmxpYyBjb25zdHJ1Y3RvcihuYW1lPzogc3RyaW5nLCBzaXplOiBudW1iZXIgPSA1MCwgYXV0b3B1cmdlOiBib29sZWFuID0gdHJ1ZSwgcmV1c2FibGVzOiBib29sZWFuID0gdHJ1ZSkge1xyXG5cdFx0XHR0aGlzLm5hbWUgPSBuYW1lIHx8IHRoaXMubmFtZTtcclxuXHRcdFx0dGhpcy5zaXplID0gc2l6ZSB8fCB0aGlzLnNpemU7XHJcblx0XHRcdHRoaXMuYXV0b3B1cmdlID0gYXV0b3B1cmdlIHx8IHRoaXMuYXV0b3B1cmdlO1xyXG5cdFx0XHR0aGlzLnJldXNhYmxlcyA9IHJldXNhYmxlcyB8fCB0aGlzLnJldXNhYmxlcztcclxuXHRcdH0gLy9jdG9yXHJcblxyXG5cdFx0cHVibGljIGdldChpdGVtOiBudW1iZXIpOiBhbnkge1xyXG5cdFx0XHRpZiAodGhpcy5jYWNoZS5sZW5ndGggPT09IDApIHRocm93IEVycm9ycy5FQkFEU1o7XHJcblxyXG5cdFx0XHRpZiAoaXRlbSA9PT0gdW5kZWZpbmVkIHx8IGl0ZW0gPT09IG51bGwpIHtcclxuXHRcdFx0XHRsZXQgaWR4OiBudW1iZXIgPSBNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkgKiAodGhpcy5jYWNoZS5sZW5ndGggLSAxKSksXHJcblx0XHRcdFx0XHR0bXA6IENhY2hlRW50cnkgPSB0aGlzLmNhY2hlW2lkeF07XHJcblx0XHRcdFx0XHJcblx0XHRcdFx0aWYgKHRoaXMucmV1c2FibGVzID09PSBmYWxzZSkgdGhpcy5jYWNoZS5zcGxpY2UoaWR4LCAxKTtcclxuXHRcdFx0XHRcclxuXHRcdFx0XHRyZXR1cm4gdG1wLmVudHJ5O1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdGxldCB0bXA6IENhY2hlRW50cnkgPSB0aGlzLmNhY2hlW2l0ZW1dO1xyXG5cclxuXHRcdFx0XHRpZiAodGhpcy5yZXVzYWJsZXMgPT09IGZhbHNlKSB0aGlzLmNhY2hlLnNwbGljZShpdGVtLCAxKTtcclxuXHJcblx0XHRcdFx0cmV0dXJuIHRtcC5lbnRyeTtcclxuXHRcdFx0fVxyXG5cdFx0fSAvL3JhbmRvbVxyXG5cclxuXHRcdGFzeW5jIHB1cmdlKGl0ZW1zOiBudW1iZXIgPSAxKTogUHJvbWlzZTxDYWNoZUVudHJ5W10+IHtcclxuXHRcdFx0bGV0IG91dDogQ2FjaGVFbnRyeVtdID0gWyBdO1xyXG5cclxuXHRcdFx0dGhpcy5fYXJyYW5nZSgpO1xyXG5cclxuXHRcdFx0YXdhaXQgY2hpbGxvdXQudW50aWwoKCk6IHZvaWQgPT4ge1xyXG5cdFx0XHRcdG91dC5wdXNoKHRoaXMuY2FjaGUuc2hpZnQoKSk7XHJcblxyXG5cdFx0XHRcdGlmICghaXRlbXMtLSkgcmV0dXJuIGNoaWxsb3V0LlN0b3BJdGVyYXRpb247XHJcblx0XHRcdH0pO1xyXG5cclxuXHRcdFx0cmV0dXJuIG91dDtcclxuXHRcdH0gLy9wdXJnZVxyXG5cclxuXHRcdHB1YmxpYyBwdXNoKGl0ZW06IGFueSk6IG51bWJlciB7XHJcblx0XHRcdGlmICh0aGlzLmF1dG9wdXJnZSAmJiB0aGlzLmNhY2hlLmxlbmd0aCA9PT0gdGhpcy5zaXplIC0gMSkgdGhpcy5wdXJnZSgpO1xyXG5cdFx0XHRcclxuXHRcdFx0cmV0dXJuIHRoaXMuY2FjaGUucHVzaCh7XHJcblx0XHRcdFx0ZW50cnk6IGl0ZW0sXHJcblx0XHRcdFx0dGltZXN0YW1wOiBEYXRlLm5vdygpXHJcblx0XHRcdH0pO1xyXG5cdFx0fSAvL3B1c2hcclxuXHJcblx0XHRfYXJyYW5nZSgpOiBDYWNoZUVudHJ5W10ge1xyXG5cdFx0XHRyZXR1cm4gdGhpcy5jYWNoZSA9IHRoaXMuY2FjaGUuc29ydCgoYTogQ2FjaGVFbnRyeSwgYjogQ2FjaGVFbnRyeSkgPT4gYS50aW1lc3RhbXAgLSBiLnRpbWVzdGFtcCk7XHJcblx0XHR9IC8vX2FycmFuZ2VcclxuXHJcblx0fSAvL0NhY2hlQmFua1xyXG5cclxuXHRleHBvcnQgYXN5bmMgZnVuY3Rpb24gZmV0Y2godXJsOiBzdHJpbmcgfCBSZXF1ZXN0T3B0aW9ucyB8IFVSTCk6IFByb21pc2U8c3RyaW5nPiB7XHJcblx0XHRyZXR1cm4gbmV3IFByb21pc2UoKHJlczogKHZhbHVlOiBzdHJpbmcpID0+IHZvaWQsIHJlaik6IHZvaWQgPT4ge1xyXG5cdFx0XHRnZXQodXJsLCAocmVzcDogSW5jb21pbmdNZXNzYWdlKTogdm9pZCA9PiB7XHJcblx0XHRcdFx0bGV0IHJlcGx5OiBzdHJpbmcgPSAnJztcclxuXHJcblx0XHRcdFx0cmVzcC5vbihcImRhdGFcIiwgKGNodW5rOiBCdWZmZXIpOiB2b2lkID0+IHtcclxuXHRcdFx0XHRcdHJlcGx5ICs9IGNodW5rO1xyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHRcdHJlc3Aub25jZShcImNsb3NlXCIsICgpID0+IHJlcyhkZWNvZGVVUklDb21wb25lbnQocmVwbHkpKSk7XHJcblx0XHRcdH0pLm9uY2UoXCJlcnJvclwiLCByZWopO1xyXG5cdFx0fSk7XHJcblx0fSAvL2ZldGNoXHJcblxyXG5cdGV4cG9ydCBhc3luYyBmdW5jdGlvbiBmYWlsc2FmZSh0aGlzOiBEaXNjb3JkLk1lc3NhZ2UsIC4uLnBhcmFtczogYW55W10pOiBQcm9taXNlPERpc2NvcmQuTWVzc2FnZSB8IERpc2NvcmQuTWVzc2FnZVtdPiB7XHJcblx0XHR0cnkge1xyXG5cdFx0XHRyZXR1cm4gYXdhaXQgdGhpcy5yZXBseSguLi5wYXJhbXMpO1xyXG5cdFx0fSBjYXRjaCAoZXJyKSB7XHJcblx0XHRcdHJldHVybiBhd2FpdCB0aGlzLmF1dGhvci5zZW5kKC4uLnBhcmFtcyk7XHJcblx0XHR9XHJcblx0fSAvL2ZhaWxzYWZlXHJcblxyXG59IC8vQ2xhc3Nlc1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgQ2xhc3NlcztcclxuZXhwb3J0IHsgY2hpbGxvdXQgfTtcclxuIl19